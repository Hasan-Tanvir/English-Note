<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Notes - Real Auto-Sync Active</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            margin-bottom: 25px;
        }
        
        h1 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-connected { background: #d1fae5; color: #065f46; }
        .status-disconnected { background: #fef3c7; color: #92400e; }
        
        .sync-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        .notes-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }
        
        .sync-log {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .log-time { color: #64748b; font-size: 0.8rem; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            h1 { font-size: 1.8rem; }
            .sync-controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>‚úÖ IELTS Notes - Auto-Sync ACTIVE</h1>
            <p style="color: #64748b; margin-bottom: 20px;">Your Supabase backend is connected and ready!</p>
            
            <div id="connection-status" class="status-badge status-connected">
                <span id="status-icon">üîó</span>
                <span id="status-text">Connected to Supabase</span>
            </div>
            
            <div class="notes-stats">
                <div class="stat-box">
                    <span class="stat-value" id="local-vocab">0</span>
                    <span>Local Vocabulary</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="local-sentences">0</span>
                    <span>Local Sentences</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="cloud-vocab">0</span>
                    <span>Cloud Vocabulary</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="cloud-sentences">0</span>
                    <span>Cloud Sentences</span>
                </div>
            </div>
            
            <div class="sync-controls">
                <button class="btn btn-success" onclick="enableAutoSync()" id="auto-sync-btn">
                    <span id="sync-icon">üîÑ</span>
                    <span id="sync-text">Enable Auto-Sync</span>
                </button>
                
                <button class="btn btn-primary" onclick="uploadToCloud()" id="upload-btn">
                    <span>‚òÅÔ∏è</span>
                    <span>Upload to Cloud</span>
                </button>
                
                <button class="btn btn-primary" onclick="downloadFromCloud()" id="download-btn">
                    <span>üì•</span>
                    <span>Download from Cloud</span>
                </button>
                
                <button class="btn btn-warning" onclick="resetSync()" id="reset-btn">
                    <span>üîÑ</span>
                    <span>Reset Sync</span>
                </button>
            </div>
            
            <div style="margin: 25px 0;">
                <h3>üì± Share Your User ID for Phone Sync</h3>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-top: 10px;">
                    <p>Your unique ID: <strong id="user-id">loading...</strong></p>
                    <button class="btn btn-primary" onclick="copyUserId()" style="margin-top: 10px;">
                        <span>üìã</span>
                        <span>Copy ID for Phone</span>
                    </button>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Enter this ID on your phone to sync automatically.
                    </p>
                </div>
            </div>
            
            <div id="sync-log" class="sync-log">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span>
                    <span class="log-success">System initialized. Ready for sync.</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üöÄ How to Sync to Phone</h2>
            <ol style="margin-left: 20px; margin-top: 15px;">
                <li><strong>On PC:</strong> Click "Enable Auto-Sync" above</li>
                <li><strong>Copy your User ID</strong> (shown above)</li>
                <li><strong>On Phone:</strong> Open the IELTS Notes app</li>
                <li><strong>Paste your User ID</strong> in the sync settings</li>
                <li><strong>Auto-sync will work instantly!</strong></li>
            </ol>
            
            <div style="margin-top: 25px; padding: 20px; background: #fef3c7; border-radius: 10px;">
                <h3>üîß Technical Details</h3>
                <p>Backend: <code>popabtduwmotxilapiai.supabase.co</code></p>
                <p>Status: <span id="tech-status">Connected ‚úì</span></p>
                <p>Last Ping: <span id="last-ping">--:--:--</span></p>
            </div>
        </div>
    </div>
    
    <script>
        // SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://popabtduwmotxilapiai.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_23tG3Xh2oLleEm77sCN7pg_5uwfWi-2';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // App state
        let autoSyncEnabled = false;
        let syncInterval = null;
        let userId = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            logMessage('System starting...');
            
            // Generate or load user ID
            await initializeUserId();
            
            // Connect to Supabase
            await testConnection();
            
            // Load local notes
            loadLocalNotes();
            
            // Check cloud notes
            await checkCloudNotes();
            
            logMessage('System ready for sync');
        });
        
        // Generate unique user ID
        async function initializeUserId() {
            // Try to get existing user ID
            userId = localStorage.getItem('ielts_user_id');
            
            if (!userId) {
                // Generate new user ID
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('ielts_user_id', userId);
                logMessage('Generated new user ID: ' + userId);
            }
            
            document.getElementById('user-id').textContent = userId;
        }
        
        // Test Supabase connection
        async function testConnection() {
            try {
                logMessage('Testing Supabase connection...');
                
                // Simple query to test connection
                const { data, error } = await supabase
                    .from('notes')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('relation "notes" does not exist')) {
                        logMessage('Creating notes table...');
                        await createNotesTable();
                    } else {
                        throw error;
                    }
                }
                
                updateStatus('‚úÖ Connected to Supabase', true);
                logMessage('Connection successful!');
                updatePing();
                
            } catch (error) {
                updateStatus('‚ùå Connection failed: ' + error.message, false);
                logMessage('Connection error: ' + error.message, 'error');
            }
        }
        
        // Create notes table if it doesn't exist
        async function createNotesTable() {
            // We'll use Supabase's REST API to create table
            // For now, we'll just inform user to create table
            logMessage('Please create table in Supabase:', 'error');
            logMessage('Table name: "notes"', 'error');
            logMessage('Columns: id (text), user_id (text), data (jsonb), updated_at (timestamp)', 'error');
            logMessage('Or run SQL: CREATE TABLE notes (id text, user_id text, data jsonb, updated_at timestamp);', 'error');
        }
        
        // Enable auto-sync
        async function enableAutoSync() {
            if (autoSyncEnabled) {
                disableAutoSync();
                return;
            }
            
            autoSyncEnabled = true;
            document.getElementById('sync-icon').textContent = '‚úÖ';
            document.getElementById('sync-text').textContent = 'Auto-Sync ON';
            document.getElementById('auto-sync-btn').style.background = '#10b981';
            
            logMessage('Auto-sync enabled. Syncing every 30 seconds...');
            
            // Initial sync
            await uploadToCloud();
            
            // Set up interval sync
            syncInterval = setInterval(async () => {
                await uploadToCloud();
            }, 30000); // Every 30 seconds
            
            // Also sync when window loses focus (user switches to phone)
            window.addEventListener('blur', async () => {
                await uploadToCloud();
            });
        }
        
        // Disable auto-sync
        function disableAutoSync() {
            autoSyncEnabled = false;
            clearInterval(syncInterval);
            
            document.getElementById('sync-icon').textContent = 'üîÑ';
            document.getElementById('sync-text').textContent = 'Enable Auto-Sync';
            document.getElementById('auto-sync-btn').style.background = '';
            
            logMessage('Auto-sync disabled');
        }
        
        // Upload notes to cloud
        async function uploadToCloud() {
            try {
                logMessage('Uploading to cloud...');
                
                const localNotes = {
                    vocab: JSON.parse(localStorage.getItem('ieltsVocabNotes') || '[]'),
                    sentences: JSON.parse(localStorage.getItem('ieltsSentenceNotes') || '[]'),
                    updated_at: new Date().toISOString()
                };
                
                // Update stats
                updateLocalStats(localNotes.vocab.length, localNotes.sentences.length);
                
                // Upload to Supabase
                const { data, error } = await supabase
                    .from('notes')
                    .upsert({
                        id: userId,
                        user_id: userId,
                        data: localNotes,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    });
                
                if (error) throw error;
                
                logMessage('‚úÖ Upload successful!');
                updateCloudStats(localNotes.vocab.length, localNotes.sentences.length);
                updatePing();
                
            } catch (error) {
                logMessage('‚ùå Upload failed: ' + error.message, 'error');
            }
        }
        
        // Download notes from cloud
        async function downloadFromCloud() {
            try {
                logMessage('Downloading from cloud...');
                
                const { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        logMessage('No data found in cloud. Upload first.');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                if (data && data.data) {
                    // Confirm before overwriting
                    if (confirm('Replace local notes with cloud version?')) {
                        localStorage.setItem('ieltsVocabNotes', JSON.stringify(data.data.vocab || []));
                        localStorage.setItem('ieltsSentenceNotes', JSON.stringify(data.data.sentences || []));
                        
                        loadLocalNotes();
                        logMessage('‚úÖ Download successful!');
                        updatePing();
                    }
                }
                
            } catch (error) {
                logMessage('‚ùå Download failed: ' + error.message, 'error');
            }
        }
        
        // Check cloud notes
        async function checkCloudNotes() {
            try {
                const { data, error } = await supabase
                    .from('notes')
                    .select('data')
                    .eq('user_id', userId)
                    .single();
                
                if (!error && data && data.data) {
                    updateCloudStats(data.data.vocab?.length || 0, data.data.sentences?.length || 0);
                    logMessage('Cloud data found: ' + (data.data.vocab?.length || 0) + ' words');
                }
            } catch (error) {
                // Ignore errors
            }
        }
        
        // Load local notes
        function loadLocalNotes() {
            const vocab = JSON.parse(localStorage.getItem('ieltsVocabNotes') || '[]');
            const sentences = JSON.parse(localStorage.getItem('ieltsSentenceNotes') || '[]');
            
            updateLocalStats(vocab.length, sentences.length);
            logMessage('Loaded ' + vocab.length + ' words, ' + sentences.length + ' sentences');
        }
        
        // Update status display
        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('connection-status');
            const iconEl = document.getElementById('status-icon');
            const textEl = document.getElementById('status-text');
            
            if (isConnected) {
                statusEl.className = 'status-badge status-connected';
                iconEl.textContent = '‚úÖ';
            } else {
                statusEl.className = 'status-badge status-disconnected';
                iconEl.textContent = '‚ùå';
            }
            
            textEl.textContent = message;
            document.getElementById('tech-status').textContent = message;
        }
        
        // Update stats
        function updateLocalStats(vocabCount, sentenceCount) {
            document.getElementById('local-vocab').textContent = vocabCount;
            document.getElementById('local-sentences').textContent = sentenceCount;
        }
        
        function updateCloudStats(vocabCount, sentenceCount) {
            document.getElementById('cloud-vocab').textContent = vocabCount;
            document.getElementById('cloud-sentences').textContent = sentenceCount;
        }
        
        // Update ping time
        function updatePing() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0') + ':' + 
                           now.getSeconds().toString().padStart(2, '0');
            document.getElementById('last-ping').textContent = timeStr;
        }
        
        // Log messages
        function logMessage(message, type = 'success') {
            const logEl = document.getElementById('sync-log');
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0') + ':' + 
                           now.getSeconds().toString().padStart(2, '0');
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${timeStr}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logEl.prepend(entry);
            
            // Keep only last 10 entries
            while (logEl.children.length > 10) {
                logEl.removeChild(logEl.lastChild);
            }
        }
        
        // Copy user ID
        function copyUserId() {
            navigator.clipboard.writeText(userId)
                .then(() => {
                    logMessage('User ID copied to clipboard!');
                    alert('User ID copied! Paste this on your phone to sync.');
                })
                .catch(() => {
                    alert('Failed to copy. Your ID is: ' + userId);
                });
        }
        
        // Reset sync
        function resetSync() {
            if (confirm('Reset sync? This clears sync settings but keeps your notes.')) {
                localStorage.removeItem('ielts_user_id');
                localStorage.removeItem('ielts_last_sync');
                autoSyncEnabled = false;
                clearInterval(syncInterval);
                
                logMessage('Sync reset. Page will reload...');
                setTimeout(() => location.reload(), 1000);
            }
        }
        
        // Auto-save when leaving page
        window.addEventListener('beforeunload', async (event) => {
            if (autoSyncEnabled) {
                await uploadToCloud();
            }
        });
    </script>
</body>
</html>
